"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Post_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Post"));
const User_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/User"));
const luxon_1 = require("luxon");
const tiny_uid_1 = __importDefault(require("tiny-uid"));
function createSlug(subject) {
    let slug = subject.trim().replace(/\s/gi, '-');
    if (slug.length > 27)
        slug = slug.substr(0, 28);
    slug = encodeURIComponent(slug);
    slug = slug += `-${tiny_uid_1.default()}`;
    return slug;
}
class PostsController {
    async list({ request }) {
        const { displayName, page, perPage } = request.qs();
        let query = Post_1.default.query()
            .preload('user')
            .where('publish_at', '<', luxon_1.DateTime.now().toISO())
            .orderBy('publish_at', 'desc');
        if (displayName) {
            const user = await User_1.default.findByOrFail('display_name', displayName);
            query = query.where('user_id', user.id);
        }
        const posts = await query.paginate(page || 1, perPage || 12);
        return posts;
    }
    async create({ auth, request }) {
        const subject = request.input('subject');
        const content = request.input('content');
        const userId = auth.user?.id;
        const publishAt = request.input('publishAt', luxon_1.DateTime.now().toISO());
        const slug = createSlug(subject);
        const post = await Post_1.default.create({
            userId,
            subject,
            content,
            slug,
            publishAt
        });
        return post;
    }
    async read({ params }) {
        const { slug } = params;
        const post = await Post_1.default.query()
            .preload('user')
            .preload('comments')
            .where('publish_at', '<=', luxon_1.DateTime.now().toISO())
            .where('slug', slug)
            .firstOrFail();
        return post;
    }
    async update({ bouncer, request, params }) {
        const { slug } = params;
        const post = await Post_1.default.findOrFail('slug', slug);
        await bouncer.with('PostPolicy').authorize('update', post);
        const subject = request.input('subject');
        const content = request.input('content');
        const publishAt = request.input('publichAt');
        if (subject) {
            if (post.subject !== subject) {
                post.slug = createSlug(subject);
            }
            post.subject = subject;
        }
        if (content)
            post.content = content;
        if (publishAt)
            post.publishAt = publishAt;
        return await post.save();
    }
    async delete({ bouncer, params }) {
        const { slug } = params;
        const post = await Post_1.default.findOrFail('slug', slug);
        await bouncer.with('PostPolicy').authorize('delete', post);
        await post.delete();
        return 'ok';
    }
}
exports.default = PostsController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUG9zdHNDb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiUG9zdHNDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsaUZBQWtDO0FBQ2xDLGlGQUFrQztBQUNsQyxpQ0FBZ0M7QUFDaEMsd0RBQTBCO0FBRTFCLFNBQVMsVUFBVSxDQUFDLE9BQU87SUFHbkIsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUE7SUFDOUMsSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLEVBQUU7UUFBRSxJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFDL0MsSUFBSSxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFBO0lBRS9CLElBQUksR0FBRyxJQUFJLElBQUksSUFBSSxrQkFBRyxFQUFFLEVBQUUsQ0FBQTtJQUMxQixPQUFPLElBQUksQ0FBQTtBQUNuQixDQUFDO0FBRUQsTUFBcUIsZUFBZTtJQUNoQyxLQUFLLENBQUMsSUFBSSxDQUFFLEVBQUMsT0FBTyxFQUFzQjtRQUN0QyxNQUFNLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsR0FBRyxPQUFPLENBQUMsRUFBRSxFQUFFLENBQUE7UUFHbkQsSUFBSSxLQUFLLEdBQUcsY0FBSSxDQUFDLEtBQUssRUFBRTthQUN2QixPQUFPLENBQUMsTUFBTSxDQUFDO2FBQ2YsS0FBSyxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUUsZ0JBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQzthQUNoRCxPQUFPLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxDQUFBO1FBRTlCLElBQUksV0FBVyxFQUFFO1lBQ2IsTUFBTSxJQUFJLEdBQUcsTUFBTSxjQUFJLENBQUMsWUFBWSxDQUFDLGNBQWMsRUFBRSxXQUFXLENB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QUFNLENBQUMsRUFBQyxPQUFPLEVBQUUsTUFBTSxFQUF1QjtRQUNoRCxNQUFNLEVBQUMsSUFBSSxFQUFDLEdBQUcsTUFBTSxDQUFBO1FBQ3JCLE1BQU0sSUFBSSxHQUFHLE1BQU0sY0FBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDaEQsTUFBTSxPQUFPLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFFMUQsTUFBTSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUE7UUFFbkIsT0FBTyxJQUFJLENBQUE7SUFFZixDQUFDO0NBRUo7QUExR0Qsa0NBMEdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtIdHRwQ29udGV4dENvbnRyYWN0IH0gZnJvbSAnQGlvYzpBZG9uaXMvQ29yZS9IdHRwQ29udGV4dCdcbmltcG9ydCBQb3N0IGZyb20gJ0FwcC9Nb2RlbHMvUG9zdCdcbmltcG9ydCBVc2VyIGZyb20gJ0FwcC9Nb2RlbHMvVXNlcidcbmltcG9ydCB7IERhdGVUaW1lIH0gZnJvbSAnbHV4b24nXG5pbXBvcnQgdWlkIGZyb20gJ3RpbnktdWlkJ1xuXG5mdW5jdGlvbiBjcmVhdGVTbHVnKHN1YmplY3Qpe1xuICAgIC8vIHNsdWcg64qUIOyEnOuyhOuLqOyXkOyEnOyekOuPmSDsg53shJwgLS0+IHJlcXVlc3QgaW5wdXQg7JeG7J2MXG4gICAgICAgIC8vIHB1Ymxpc2hfYXQg6rec7LmZIO2VhOyalFxuICAgICAgICBsZXQgc2x1ZyA9IHN1YmplY3QudHJpbSgpLnJlcGxhY2UoL1xccy9naSwgJy0nKVxuICAgICAgICBpZiAoc2x1Zy5sZW5ndGggPiAyNykgc2x1ZyA9IHNsdWcuc3Vic3RyKDAsIDI4KVxuICAgICAgICBzbHVnID0gZW5jb2RlVVJJQ29tcG9uZW50KHNsdWcpXG4gICAgICAgIC8vIOykkeuztSDsspjrpqwg7ZW06rKwIOy9lOuTnCAtIOuSpOyXkCB1bmlxIOu5hOyKpOustOumsO2VnCDsp6bsnYAg7L2U65Oc66W8IOu2meyduOuLpC5cbiAgICAgICAgc2x1ZyA9IHNsdWcgKz0gYC0ke3VpZCgpfWBcbiAgICAgICAgcmV0dXJuIHNsdWdcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUG9zdHNDb250cm9sbGVyIHtcbiAgICBhc3luYyBsaXN0ICh7cmVxdWVzdH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICAgICAgY29uc3QgeyBkaXNwbGF5TmFtZSwgcGFnZSwgcGVyUGFnZSB9ID0gcmVxdWVzdC5xcygpXG4gICAgICAgIC8vIGRpc3BsYXlOYW1lIOydtCDsl4bripQg7KCE7LK0IOuqqeuhnSDsmpTssq1cbiAgICAgICAgLy8gMi4gZGlzcGxheU5hbWUg7J2EIOq4sOykgOycvOuhnCDtlYTthLDrp4FcbiAgICAgICAgbGV0IHF1ZXJ5ID0gUG9zdC5xdWVyeSgpXG4gICAgICAgIC5wcmVsb2FkKCd1c2VyJylcbiAgICAgICAgLndoZXJlKCdwdWJsaXNoX2F0JywgJzwnLCBEYXRlVGltZS5ub3coKS50b0lTTygpKVxuICAgICAgICAub3JkZXJCeSgncHVibGlzaF9hdCcsICdkZXNjJylcbiAgICAgICAgXG4gICAgICAgIGlmKCBkaXNwbGF5TmFtZSApe1xuICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5T3JGYWlsKCdkaXNwbGF5X25hbWUnLCBkaXNwbGF5TmFtZSlcbiAgICAgICAgICAgIHF1ZXJ5ID0gcXVlcnkud2hlcmUoJ3VzZXJfaWQnLCB1c2VyLmlkKVxuICAgICAgICAgICAgLy8gY29uc3QgcG9zdHMgPSBhd2FpdCBQb3N0LnF1ZXJ5KCkud2hlcmUoJ2Rpc3BsYXlOYW1lJywgZGlzcGxheU5hbWUpLnBhZ2luYXRlKDEsMTIpXG4gICAgICAgICAgICAvLyByZXR1cm4gcG9zdHNcbiAgICAgICAgfVxuICAgICAgICAvLyBlbHNlIHtcbiAgICAgICAgLy8gICAgIGNvbnN0IHBvc3RzID0gYXdhaXQgUG9zdC5xdWVyeSgpLnBhZ2luYXRlKDEsMTIpXG4gICAgICAgIC8vICAgICByZXR1cm4gcG9zdHNcbiAgICAgICAgLy8gfVxuXG4gICAgICAgIGNvbnN0IHBvc3RzID0gYXdhaXQgcXVlcnkucGFnaW5hdGUocGFnZSB8fCAxLCBwZXJQYWdlIHx8IDEyKVxuICAgICAgICByZXR1cm4gcG9zdHNcbiAgICB9XG5cbiAgICBhc3luYyBjcmVhdGUoe2F1dGgsIHJlcXVlc3R9IDogSHR0cENvbnRleHRDb250cmFjdCl7XG4gICAgICAgIGNvbnN0IHN1YmplY3QgPSByZXF1ZXN0LmlucHV0KCdzdWJqZWN0JylcbiAgICAgICAgY29uc3QgY29udGVudCA9IHJlcXVlc3QuaW5wdXQoJ2NvbnRlbnQnKVxuICAgICAgICBjb25zdCB1c2VySWQgPSBhdXRoLnVzZXI/LmlkXG4gICAgICAgIGNvbnN0IHB1Ymxpc2hBdCA9IHJlcXVlc3QuaW5wdXQoJ3B1Ymxpc2hBdCcsIERhdGVUaW1lLm5vdygpLnRvSVNPKCkpXG4gICAgICAgIFxuICAgICAgICBjb25zdCBzbHVnID0gY3JlYXRlU2x1ZyhzdWJqZWN0KVxuXG4gICAgICAgIGNvbnN0IHBvc3QgPSBhd2FpdCBQb3N0LmNyZWF0ZSh7XG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICBzdWJqZWN0LFxuICAgICAgICAgICAgY29udGVudCxcbiAgICAgICAgICAgIHNsdWcsXG4gICAgICAgICAgICBwdWJsaXNoQXRcbiAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuIHBvc3RcbiAgICB9XG5cbiAgICBhc3luYyByZWFkKHtwYXJhbXN9IDogSHR0cENvbnRleHRDb250cmFjdCl7XG4gICAgICAgIC8vIGxldCB7aWR9ID0gcGFyYW1zXG4gICAgICAgIC8vIGxldCBzbHVnXG4gICAgICAgIC8vIGlmIChOdW1iZXIuaXNOYU4oIHBhcnNlSW50KGlkLCAxMCkpKXtcbiAgICAgICAgLy8gICAgIHNsdWcgPSBpZFxuICAgICAgICAvLyB9XG5cbiAgICAgICAgY29uc3Qge3NsdWd9ID0gcGFyYW1zXG5cbiAgICAgICAgY29uc3QgcG9zdCA9ICBhd2FpdCBQb3N0LnF1ZXJ5KClcbiAgICAgICAgLnByZWxvYWQoJ3VzZXInKVxuICAgICAgICAucHJlbG9hZCgnY29tbWVudHMnKVxuICAgICAgICAud2hlcmUoJ3B1Ymxpc2hfYXQnLCAnPD0nLCBEYXRlVGltZS5ub3coKS50b0lTTygpKVxuICAgICAgICAud2hlcmUoJ3NsdWcnLCBzbHVnKVxuICAgICAgICAuZmlyc3RPckZhaWwoKVxuICAgICAgICAvLyBpZiAoc2x1ZykgcXVlcnkgPSBxdWVyeS53aGVyZSgnc2x1ZycsIHNsdWcpXG4gICAgICAgIC8vIGVsc2UgcXVlcnkgPSBxdWVyeS53aGVyZSgnaWQnLCBpZClcblxuICAgICAgICAvLyBjb25zdCBwb3N0ID0gYXdhaXQgcXVlcnkuZmlyc3QoKVxuICAgICAgICAvLyAud2hlcmUoJ2lkJywgaWQpXG4gICAgICAgIC8vIC5maXJzdCgpXG4gICAgICAgIC8vIGlmKCFwb3N0KSB7XG4gICAgICAgIC8vICAgICByZXNwb25zZS5zdGF0dXMoNDA0KVxuICAgICAgICAvLyAgICAgcmV0dXJuIHsgbWVzc2FnZSA6ICfsobDtmoztlaAg642w7J207YSw6rCAIOyXhuyKteuLiOuLpC4nfVxuICAgICAgICAvLyB9XG4gICAgICAgIHJldHVybiBwb3N0XG4gICAgICAgIFxuICAgIH1cblxuICAgIGFzeW5jIHVwZGF0ZSAoe2JvdW5jZXIsIHJlcXVlc3QsIHBhcmFtc306SHR0cENvbnRleHRDb250cmFjdCl7XG4gICAgICAgIGNvbnN0IHtzbHVnfSA9IHBhcmFtc1xuICAgICAgICBjb25zdCBwb3N0ID0gYXdhaXQgUG9zdC5maW5kT3JGYWlsKCdzbHVnJywgc2x1ZylcblxuICAgICAgICAvLyBhd2FpdCBib3VuY2VyLmF1dGhvcml6ZSgnZWRpdFBvc3QnLCBwb3N0KVxuICAgICAgICBhd2FpdCBib3VuY2VyLndpdGgoJ1Bvc3RQb2xpY3knKS5hdXRob3JpemUoJ3VwZGF0ZScsIHBvc3QpXG5cbiAgICAgICAgY29uc3Qgc3ViamVjdCA9IHJlcXVlc3QuaW5wdXQoJ3N1YmplY3QnKVxuICAgICAgICBjb25zdCBjb250ZW50ID0gcmVxdWVzdC5pbnB1dCgnY29udGVudCcpXG4gICAgICAgIGNvbnN0IHB1Ymxpc2hBdCA9IHJlcXVlc3QuaW5wdXQoJ3B1YmxpY2hBdCcpXG5cbiAgICAgICAgaWYoc3ViamVjdCl7XG4gICAgICAgICAgICBpZiAocG9zdC5zdWJqZWN0ICE9PSBzdWJqZWN0KXtcbiAgICAgICAgICAgICAgICBwb3N0LnNsdWcgPSBjcmVhdGVTbHVnKHN1YmplY3QpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwb3N0LnN1YmplY3QgPSBzdWJqZWN0XG4gICAgICAgIH1cbiAgICAgICAgaWYoIGNvbnRlbnQgKSBwb3N0LmNvbnRlbnQgPSBjb250ZW50XG4gICAgICAgIGlmKCBwdWJsaXNoQXQpIHBvc3QucHVibGlzaEF0ID0gcHVibGlzaEF0XG4gICAgICAgIHJldHVybiBhd2FpdCBwb3N0LnNhdmUoKVxuICAgICAgICBcbiAgICB9XG5cbiAgICBhc3luYyBkZWxldGUoe2JvdW5jZXIsIHBhcmFtc30gOiBIdHRwQ29udGV4dENvbnRyYWN0KXtcbiAgICAgICAgY29uc3Qge3NsdWd9ID0gcGFyYW1zXG4gICAgICAgIGNvbnN0IHBvc3QgPSBhd2FpdCBQb3N0LmZpbmRPckZhaWwoJ3NsdWcnLCBzbHVnKVxuICAgICAgICBhd2FpdCBib3VuY2VyLndpdGgoJ1Bvc3RQb2xpY3knKS5hdXRob3JpemUoJ2RlbGV0ZScsIHBvc3QpXG5cbiAgICAgICAgYXdhaXQgcG9zdC5kZWxldGUoKVxuICAgIFxuICAgICAgICByZXR1cm4gJ29rJ1xuXG4gICAgfVxuXG59XG4iXX0=